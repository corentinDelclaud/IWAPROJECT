# ==============================================================================
# Makefile - IWA PROJECT
# ==============================================================================
# Commandes simplifi√©es pour g√©rer l'infrastructure Docker
# ==============================================================================

.PHONY: help start stop restart logs build clean health ps

# Couleurs pour l'affichage
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m # No Color

help: ## Affiche cette aide
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë         IWA PROJECT - Commandes disponibles               ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""

start: ## D√©marre tous les services
	@echo "$(BLUE)üöÄ D√©marrage de tous les services...$(NC)"
	@./start-docker.sh

stop: ## Arr√™te tous les services
	@echo "$(BLUE)üõë Arr√™t de tous les services...$(NC)"
	@docker-compose down

restart: ## Red√©marre tous les services
	@echo "$(YELLOW)üîÑ Red√©marrage de tous les services...$(NC)"
	@docker-compose restart

logs: ## Affiche les logs de tous les services
	@docker-compose logs -f

build: ## Reconstruit toutes les images Docker
	@echo "$(BLUE)üî® Reconstruction des images...$(NC)"
	@docker-compose build

rebuild: ## Reconstruit et red√©marre tous les services
	@echo "$(BLUE)üî® Reconstruction et red√©marrage...$(NC)"
	@docker-compose up -d --build

clean: ## Arr√™te et supprime tout (conteneurs, volumes, images)
	@echo "$(YELLOW)‚ö†Ô∏è  Nettoyage complet...$(NC)"
	@docker-compose down -v
	@docker rmi iwa-api-gateway iwa-auth-service iwa-user-microservice iwa-service-catalog 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

health: ## V√©rifie la sant√© de tous les services
	@./check-health.sh

ps: ## Affiche l'√©tat de tous les conteneurs
	@docker-compose ps

# Commandes sp√©cifiques par service
logs-gateway: ## Logs de l'API Gateway
	@docker-compose logs -f api-gateway

logs-auth: ## Logs du Auth Service
	@docker-compose logs -f auth-service

logs-user: ## Logs du User Microservice
	@docker-compose logs -f user-microservice

logs-catalog: ## Logs du Service Catalog
	@docker-compose logs -f service-catalog

logs-keycloak: ## Logs de Keycloak
	@docker-compose logs -f keycloak

# Commandes pour les bases de donn√©es
db-users: ## Se connecte √† la base Users
	@docker exec -it iwa-postgres-users psql -U postgres -d iwa_users

db-catalog: ## Se connecte √† la base Catalog
	@docker exec -it iwa-postgres-catalog psql -U postgres -d iwa_catalog

db-keycloak: ## Se connecte √† la base Keycloak
	@docker exec -it iwa-postgres-keycloak psql -U keycloak -d keycloak
